<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados de b√∫squeda - deedpri</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Estilos -->
  <link rel="stylesheet" href="../assets/css/buscador.css">
  <link rel="stylesheet" href="../assets/css/resultados.css">
</head>
<body>

  <!-- Header de b√∫squeda -->
  <div class="search-header">
    <div class="search-header-content">
      <a href="negocios-index.html" class="back-link">
        <i class="fas fa-arrow-left"></i>
        Volver al buscador
      </a>
      <h1 id="resultadosTitulo">Resultados de b√∫squeda</h1>
      <div class="search-info" id="searchInfo"></div>
    </div>
  </div>

  <!-- Contenedor de resultados -->
  <div class="results-container">
    <div class="results-count" id="resultsCount"></div>
    
    <!-- CHIP DE VER TODOS -->
    <div class="filter-suggestion" id="filterSuggestion" style="display: none;">
      <span class="suggestion-text">
        üí° Tambi√©n hay m√°s negocios en otras ubicaciones
      </span>
      <button class="btn-ver-todos" id="btnVerTodos">
        üìç Ver en todas las ubicaciones
        <span class="total-count"></span>
      </button>
    </div>
    
    <div id="resultadosContenedor"></div>
  </div>

  <!-- Scripts -->
  <script src="../assets/js/negocios-data.js"></script>
  <script src="../assets/js/sinonimos.js"></script>
  <script src="../assets/js/buscador-inteligente.js"></script>
  <script src="../assets/js/buscador.js"></script>
  
  <script>
    // ============================================
    // TODO FUNCIONA SOLO CON PAR√ÅMETROS URL
    // Sin sessionStorage, sin cach√©
    // ============================================
    
    console.log('üîÑ P√°gina de resultados cargada');
    
    // Obtener par√°metros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q') || '';
    const categoria = urlParams.get('cat') || '';
    const ubicacion = urlParams.get('loc') || 'todos';
    
    console.log('üìã Par√°metros recibidos:', { query, categoria, ubicacion });
    
    // BUSCAR usando el buscador inteligente
    let resultados = [];
    
    if (query) {
      // B√∫squeda por texto
      console.log('üîç Buscando por query:', query);
      resultados = buscarNegocios(query, ubicacion);
    } else if (categoria) {
      // B√∫squeda por categor√≠a
      console.log('üè∑Ô∏è Buscando por categor√≠a:', categoria);
      resultados = obtenerPorCategoria(categoria, ubicacion);
    } else {
      // Mostrar todos
      console.log('üìã Mostrando todos los negocios');
      resultados = ubicacion && ubicacion !== 'todos' 
        ? negociosDB.filter(n => n.municipio === ubicacion)
        : negociosDB;
    }
    
    console.log(`‚úÖ Resultados encontrados: ${resultados.length}`);
    
    // ============================================
    // MOSTRAR INFORMACI√ìN DE B√öSQUEDA
    // ============================================
    
    const tituloElement = document.getElementById('resultadosTitulo');
    const infoElement = document.getElementById('searchInfo');
    
    let titulo = 'Resultados de b√∫squeda';
    let infoHTML = '';
    
    if (query) {
      titulo = `Resultados para "${query}"`;
      infoHTML += `<span><i class="fas fa-search"></i> ${query}</span>`;
    }
    
    if (categoria) {
      const categoriaNombre = categoria.charAt(0).toUpperCase() + categoria.slice(1);
      titulo = `Categor√≠a: ${categoriaNombre}`;
      infoHTML += `<span><i class="fas fa-tag"></i> ${categoriaNombre}</span>`;
    }
    
    if (ubicacion && ubicacion !== 'todos') {
      const ubicacionNombre = ubicacion.replace('-', ' ')
        .split(' ')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
      infoHTML += `<span><i class="fas fa-map-marker-alt"></i> ${ubicacionNombre}</span>`;
    }
    
    tituloElement.textContent = titulo;
    infoElement.innerHTML = infoHTML;
    
    // ============================================
    // MOSTRAR CONTADOR
    // ============================================
    
    const countElement = document.getElementById('resultsCount');
    countElement.textContent = `${resultados.length} ${resultados.length === 1 ? 'negocio encontrado' : 'negocios encontrados'}`;
    
    // ============================================
    // SUGERENCIA DE VER TODAS LAS UBICACIONES
    // ============================================
    
    const filterSuggestion = document.getElementById('filterSuggestion');
    const btnVerTodos = document.getElementById('btnVerTodos');
    
    if (ubicacion && ubicacion !== 'todos') {
      // Contar todos los negocios sin filtro
      const todosLosNegocios = query ? buscarNegocios(query, 'todos') : negociosDB;
      const diferencia = todosLosNegocios.length - resultados.length;
      
      if (diferencia > 0) {
        // Mostrar sugerencia
        filterSuggestion.style.display = 'flex';
        btnVerTodos.querySelector('.total-count').textContent = `(${todosLosNegocios.length} total)`;
        
        // Click en "Ver todos"
        btnVerTodos.addEventListener('click', function() {
          // Recargar sin filtro de ubicaci√≥n
          const params = new URLSearchParams(window.location.search);
          params.set('loc', 'todos');
          window.location.href = `resultados.html?${params.toString()}`;
        });
      }
    }
    
    // ============================================
    // MOSTRAR RESULTADOS
    // ============================================
    
    const contenedor = document.getElementById('resultadosContenedor');
    
    if (resultados.length === 0) {
      contenedor.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">
            <i class="fas fa-search"></i>
          </div>
          <h2>No encontramos resultados</h2>
          <p>Intenta con otros t√©rminos de b√∫squeda o explora por categor√≠as</p>
          <br>
          <a href="negocios-index.html" class="btn-action btn-whatsapp">
            <i class="fas fa-arrow-left"></i>
            Volver al buscador
          </a>
        </div>
      `;
    } else {
      resultados.forEach(negocio => {
        const card = crearCardNegocio(negocio);
        contenedor.innerHTML += card;
      });
      
      // Agregar event listeners a las cards
      document.querySelectorAll('.negocio-card').forEach(card => {
        card.addEventListener('click', function(e) {
          // No navegar si se clicke√≥ un bot√≥n
          if (e.target.tagName === 'A' || e.target.closest('a')) {
            return;
          }
          const id = this.dataset.id;
          window.location.href = `perfil.html?id=${id}`;
        });
      });
    }
    
    // ============================================
    // FUNCI√ìN PARA CREAR CARD DE NEGOCIO
    // ============================================
    
    function crearCardNegocio(negocio) {
      const planClass = negocio.plan || 'gratis';
      const badge = negocio.destacado ? `<div class="plan-badge ${planClass}">${
        planClass === 'premium-plus' ? 'üëë PREMIUM PLUS' : 
        planClass === 'premium' ? '‚≠ê DESTACADO' : ''
      }</div>` : '';
      
      const rating = negocio.rating ? `
        <div class="negocio-rating">
          ${'‚òÖ'.repeat(Math.floor(negocio.rating))}${'‚òÜ'.repeat(5 - Math.floor(negocio.rating))}
          <span style="color: #666;">${negocio.rating} (${negocio.reviews || 0} rese√±as)</span>
        </div>
      ` : '';
      
      const whatsapp = negocio.whatsapp ? `
        <a href="https://wa.me/52${negocio.whatsapp}" class="btn-action btn-whatsapp" target="_blank" onclick="event.stopPropagation()">
          <i class="fab fa-whatsapp"></i>
          WhatsApp
        </a>
      ` : '';
      
      const telefono = negocio.telefono ? `
        <a href="tel:${negocio.telefono}" class="btn-action btn-telefono" onclick="event.stopPropagation()">
          <i class="fas fa-phone"></i>
          Llamar
        </a>
      ` : '';
      
      return `
        <div class="negocio-card ${planClass}" data-id="${negocio.id}">
          ${badge}
          <div class="negocio-grid">
            <img src="${negocio.foto}" alt="${negocio.nombre}" class="negocio-foto">
            <div class="negocio-info">
              <h3 class="negocio-nombre">${negocio.nombre}</h3>
              ${rating}
              <p class="negocio-categoria">
                <i class="fas fa-tag"></i>
                ${negocio.subcategoria || negocio.categoria}
              </p>
              <p class="negocio-direccion">
                <i class="fas fa-map-marker-alt"></i>
                ${negocio.direccion}
              </p>
            </div>
          </div>
        </div>
      `;
    }
    
    console.log(`‚úÖ Mostrando ${resultados.length} resultados en pantalla`);
  </script>

</body>
</html>
